---
title: "integrationBenchmarkReport"
author: "Leonard Herault"
date: '2022-12-09'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## libraries

```{r cars}
library(ggplot2)
library(Seurat)
library(ggrepel)
```




```{bash}
#cp visualization/scIB_knit_table.R ../scib-pipeline/reports/
#mv scIB_knit_table.R knit_table.R
```

```{r}
# install.packages('dynutils')
# install.packages('magick')
# install.packages('cowplot')
# install.packages("ggforce")
# install.packages('ggimage')
# install.packages('Hmisc')
# install.packages("plyr")
#source('../../scib-reproducibility/visualization/plotSingleTaskRNA.R')


library(tibble)
library(RColorBrewer)
library(dynutils)
library(stringr)
library(Hmisc)
library(plyr)


# source("knit_table.R") # Please put knit_table.R in your working dir
# 
# source("R_fun_report.R")


```

```{r}
library(STACAS)
library(Seurat)
library(scIntegrationMetrics)
library(anndata)
```

## Compute true mislabelling rate
```{r}
misRateTable <- data.frame()
celltypeLabel = c("celltype","celltype","final_annotation")
names(celltypeLabel) <- c('tcells_atlas','human_pancreas','immune_cell_hum')

for (task in c('tcells_atlas','human_pancreas','immune_cell_hum')) {
  adata <- read_h5ad(paste0("../data/",task,"/prepare/unscaled/hvg/adata_pre.h5ad"))
  for (p in c(10,20,50)) {
    misRate <- table(adata$obs[,paste0('percentShuffling_',p,'_',celltypeLabel[task])] == adata$obs[,celltypeLabel[task]])[1]/length(adata$obs[,celltypeLabel[task]])
    misRateTable <- rbind(misRateTable,c(task, p, misRate))
  }
}
misRateTable$percentMislabelling <- as.numeric(misRateTable$percentMislabelling)
colnames(misRateTable) <- c("task","percentShuffling","percentMislabelling")

ggplot(misRateTable, aes(x = percentShuffling , y = percentMislabelling, fill = task)) + geom_bar(stat="identity", color="black", position=position_dodge())
```




```{r}
metricsR <- read.csv("../data/metrics_R.csv",row.names = 1)

scenarios <- str_split_fixed(rownames(metricsR),pattern = "/",n=7)
head(scenarios)

scenarios <- scenarios[,-1]
colnames(scenarios) <- c("task","percentShuffling","folder","scaling","features","method")
metricsR <- cbind(scenarios,metricsR)

metricsR$method <- str_split_fixed(metricsR$method,pattern = "/",n=2)[,2]
metricsR$output <- str_split_fixed(metricsR$method,pattern = "_",n=2)[,2]
metricsR$tool <- str_split_fixed(metricsR$method,pattern = "_",n=2)[,1]

metricsR_unshuffled <- read.csv("../../data/metrics_R.csv",row.names = 1)

scenarios_unshuffled <- str_split_fixed(rownames(metricsR_unshuffled),pattern = "/",n=6)
head(scenarios_unshuffled)

scenarios_unshuffled <- data.frame(scenarios_unshuffled[,-1])

colnames(scenarios_unshuffled) <- c("task","folder","scaling","features","method")
scenarios_unshuffled$method <- str_split_fixed(scenarios_unshuffled$method,pattern = "/",n=2)[,2]



keptIndex <- which(scenarios_unshuffled$task %in% c("human_pancreas","immune_cell_hum", "tcells_atlas") &
                     scenarios_unshuffled$scaling %in% c("unscaled") &
                     scenarios_unshuffled$method %in% c("scanvi_embed","scvi_embed","semiSupSTACAS_embed","STACAS_embed","scgen_full","unintegrated_full"))

rn <- rownames(metricsR_unshuffled)[keptIndex]

metricsR_unshuffled <- cbind(scenarios_unshuffled[keptIndex,],metricsR_unshuffled[keptIndex,])
rownames(metricsR_unshuffled) <- rn

metricsR_unshuffled$output <- str_split_fixed(metricsR_unshuffled$method,pattern = "_",n=2)[,2]
metricsR_unshuffled$tool <- str_split_fixed(metricsR_unshuffled$method,pattern = "_",n=2)[,1]

metricsR_unshuffled$percentShuffling = "None"

head(metricsR_unshuffled)

metricsR <- rbind(metricsR,metricsR_unshuffled[,colnames(metricsR)])
metricsR
```




```{r}
metrics <- read.csv("../data/metrics.csv",row.names = 1)

scenarios <- str_split_fixed(rownames(metrics),pattern = "/",n=7)
head(scenarios)

scenarios <- scenarios[,-1]
colnames(scenarios) <- c("task","percentShuffling","folder","scaling","features","method")
metrics <- cbind(scenarios,metrics)

#metrics$method <- str_split_fixed(metrics$method,pattern = "/",n=2)[,2]
metrics$output <- str_split_fixed(metrics$method,pattern = "_",n=2)[,2]
metrics$tool <- str_split_fixed(metrics$method,pattern = "_",n=2)[,1]

metrics_unshuffled <- read.csv("../../data/metrics.csv",row.names = 1)

scenarios_unshuffled <- str_split_fixed(rownames(metrics_unshuffled),pattern = "/",n=6)
head(scenarios_unshuffled)

scenarios_unshuffled <- data.frame(scenarios_unshuffled[,-1])

colnames(scenarios_unshuffled) <- c("task","folder","scaling","features","method")
#scenarios_unshuffled$method <- str_split_fixed(scenarios_unshuffled$method,pattern = "/",n=2)[,2]



keptIndex <- which(scenarios_unshuffled$task %in% c("human_pancreas","immune_cell_hum", "tcells_atlas") &
                     scenarios_unshuffled$scaling %in% c("unscaled") &
                     scenarios_unshuffled$method %in% c("scanvi_embed","scvi_embed","semiSupSTACAS_embed","STACAS_embed","scgen_full","unintegrated_full"))

rn <- rownames(metrics_unshuffled)[keptIndex]


metrics_unshuffled <- cbind(scenarios_unshuffled[keptIndex,],metrics_unshuffled[keptIndex,])

rownames(metrics_unshuffled) <- rn

metrics_unshuffled$output <- str_split_fixed(metrics_unshuffled$method,pattern = "_",n=2)[,2]
metrics_unshuffled$tool <- str_split_fixed(metrics_unshuffled$method,pattern = "_",n=2)[,1]

metrics_unshuffled$percentShuffling = "None"

head(metrics_unshuffled)

metrics <- rbind(metrics,metrics_unshuffled[,colnames(metrics)])
metrics




```

```{r}
metrics$ASW_label_raw <- 2*metrics$ASW_label-1
ggplot(metrics,aes(x = percentShuffling,color=method,y=ASW_label_raw,group = method)) +geom_point()+ geom_line() +  facet_wrap('~task') +
  scale_x_discrete(guide = guide_axis(angle = 45))
```
```{r}
ggplot(metricsR,aes(x = percentShuffling,color=method,y=CiLISI,group = method)) +geom_point()+ geom_line() +  facet_wrap('~task') +
  scale_x_discrete(guide = guide_axis(angle = 45))
```
```{r}
rownames(metricsR) <- gsub(rownames(metricsR),pattern = "/R/",replacement = "/")
allMetrics <- cbind(metrics,metricsR[rownames(metrics),c("CiLISI","CiLISI_means")])
```



```{r fig.height=0.75,fig.width=3}

for (t in unique(allMetrics$task)) {
  plot(ggplot(allMetrics[allMetrics$task == t,],aes(x = CiLISI, y= ASW_label_raw, color = method, group = method)) +geom_point() + facet_wrap(c("task","percentShuffling"), ncol = 4))
}



```





```{r}
rownames(metricsR) <- gsub(rownames(metricsR),pattern = "/R/",replacement = "/")

metrics <- cbind(metrics,metricsR[rownames(metrics),c("CiLISI","CiLISI_means")])

metrics$ASW_label_raw <- 2*metrics$ASW_label-1
```

```{r fig.height=2,fig.width=3}
ggplot(metrics,aes(x = scaling,fill=output,y=ASW_label_raw,fill = output,group = task,color = task)) +geom_point()+ geom_line() +
  scale_x_discrete(guide = guide_axis(angle = 45))+ facet_wrap("~method") 
```

```{r fig.height=2,fig.width=3}
ggplot(metrics,aes(x = scaling,fill=output,y=CiLISI,fill = output,group = task,color = task)) +geom_point()+ geom_line() +
  scale_x_discrete(guide = guide_axis(angle = 45))+ facet_wrap("~method") 
```
```{r fig.height=3,fig.width=3}
ggplot(metrics,aes(x = scaling,fill=output,y=ASW_label_raw,fill = output,group = task,color = task)) +geom_point()+ geom_line() +
  scale_x_discrete(guide = guide_axis(angle = 45))+ facet_wrap("~method") 
```


